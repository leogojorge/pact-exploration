# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  PACT_BROKER_TOKEN: ${{ secrets.PACTFLOW_TOKEN_FOR_CI_CD_WORKSHOP }}
  GIT_COMMIT: ${{ github.sha }}
  GIT_REF: ${{ github.ref }}
  GITHUB_ORG: "pactflow"
  GITHUB_WEBHOOK_UUID: "04510dc1-7f0a-4ed2-997d-114bfa86f8ad"
  #PACT_CLI: "docker run --rm -v ${PWD}:${PWD} -e https://stonepagamentos.pactflow.io -e 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 pactfoundation/pact-cli"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: Restore dependencies
      run: dotnet restore
      working-directory: PactExploration

    - name: Build
      run: dotnet build --no-restore
      working-directory: PactExploration

  test:
    runs-on: ubuntu-latest
    needs: build
    #strategy:
    #  matrix:
    #    pact_provider: [
    #        # "pactflow-example-bi-directional-provider-dredd",
    #        # "pactflow-example-bi-directional-provider-restassured",
    #        # "pactflow-example-bi-directional-provider-postman",
    #        #'pactflow-example-provider'
    #        'WeConsumingSomeone-PostmanApi'
    #    ]
    steps:
    - uses: actions/checkout@v3
    - name: Test
      run: dotnet test
      working-directory: PactExploration.Tests
  # Runs on branches as well, so we know the status of our PRs
    - run: docker pull pactfoundation/pact-cli:latest
    - name: Can I deploy?
    - run: |
       GIT_BRANCH=${GIT_REF:11} 
       docker run --rm -v ${PWD}:${PWD} 
       -e https://stonepagamentos.pactflow.io 
       -e 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 
       pactfoundation/pact-cli 
       publish ${PWD}/pacts --consumer-app-version 
       git rev-parse HEAD --branch 
       git rev-parse --abbrev-ref HEAD --broker-base-url https://stonepagamentos.pactflow.io

  # Only deploy from master
    - uses: actions/checkout@v3
    - run: |
       docker pull pactfoundation/pact-cli:latest 
       .env 
       echo"\n========== STAGE can-i-deploy? ==========\n" 
       docker run --rm -v ${PWD}:${PWD} -e PACT_BROKER_BASE_URL -e PACT_BROKER_TOKEN 
       pactfoundation/pact-cli broker can-i-deploy -b https://stonepagamentos.pactflow.io --pacticipant ${PACTICIPANT} 
       --version ${GIT_COMMIT} 
       --to-environment ${ENVIRONMENT} 
       --retry-while-unknown 30 
       --retry-interval 10